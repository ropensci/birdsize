---
title: "community"
output: 
  rmarkdown::html_vignette:
      toc: true
vignette: >
  %\VignetteIndexEntry{community}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=F}
library(birdsize)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
```

The `community_generate` and `community_summarize` functions are flexible, high-level functions for generating individual-level body mass and metabolic rate estimates for all the individuals in a community.


# Generating estimates using `community_generate`

`community_generate` takes a dataframe with species-level information (AOU, scientific name, or mean and/or standard deviation body mass) and population sizes, and returns a dataframe of individual-level mass and BMR measurements for all the entries in the input data frame. 

## Simulations using AOU 

This workflow is most closely designed to work with the North American Breeding Bird Survey. 

Here, we use a synthetic dataset with the same column names as data downloaded from the North American Breeding Bird Survey (`demo_route_raw`). First, we filter the data to remove poorly-sampled or unidentified species. For speed, we also filter to records only from the years 1994-1996. This results in a data frame with species' abundances for all species from 1994-1996 on this (hypothetical) route, and additional data fields identifying the route.


```{r}

demo_route_raw <- demo_route_raw

demo_route_clean <- demo_route_raw %>%
  filter_bbs_survey() %>%
  dplyr::filter(year %in% 1994:1996)

head(demo_route_clean)
```

`community_generate` can take this table and generate simulated individual measurements with no additional tweaks. It uses the `AOU` and `speciestotal` columns from `demo_route_clean` to look up species' mean and standard deviation body masses based on their AOU and then draw individual size measurements from a normal distribution with those parameters. 

```{r}
set.seed(22)

demo_route_sims <- community_generate(community_data_table = demo_route_clean)

head(demo_route_sims)
```


## Simulation given species' names

If the AOU is not known or not provided, `community_generate` will attempt to look up species' size parameters based on their scientific name.

Here we generate a version of `demo_route_clean` with no `AOU` column:

```{r}

demo_route_names <- demo_route_clean %>%
  left_join(select(sd_table, AOU, scientific_name)) %>%
  select(-AOU)

```

`community_generate` still runs, but note that the `sd_method` here is listed as `Scientific name lookup` rather than `AOU lookup` (above). 

```{r}

set.seed(22)

demo_route_names_sims <- community_generate(demo_route_names)

head(demo_route_names_sims)

```


## Simulation given mean size measurements

If species name or AOU are not known, or are not included in this dataset (see `known_species` for the full set of included species), estimates can still be generated by providing the mean and, if available, standard deviation of body mass directly. If standard deviation is provided, it will be used; if not, it will be estimated based on the scaling relationship between mean and standard deviation of body mass for birds (see the `scaling` vignette).

Here we generate a version of `demo_route_clean` with no AOU or species name columns, but with records of mean body size for all species. Note that the mean body mass must be in a column called `mean_size`. 

```{r}

demo_route_means <- demo_route_clean %>%
  left_join(select(sd_table, AOU, mean_mass)) %>%
  select(-AOU) %>%
  rename(mean_size = mean_mass)

set.seed(22)

demo_route_means_sims <- community_generate(demo_route_means)

head(demo_route_means_sims)


```

Here, we include standard deviation measurements in a column called `sd_size`: 

```{r}

demo_route_mean_sds <- demo_route_clean %>%
  left_join(select(sd_table, AOU, mean_mass, mean_sd)) %>%
  select(-AOU) %>%
  rename(mean_size = mean_mass,
         sd_size = mean_sd)



set.seed(22)

demo_route_mean_sds_sims <- community_generate(demo_route_mean_sds)

head(demo_route_mean_sds_sims)

```


<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>R1 • birdsize</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css"><script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet"><script src="pkgdown.js"></script><meta property="og:title" content="R1"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-title-body">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">birdsize</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="articles/birdsize.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="articles/bbs-data.html">bbs-data</a>
    </li>
    <li>
      <a href="articles/community.html">community</a>
    </li>
    <li>
      <a href="articles/populations.html">populations</a>
    </li>
    <li>
      <a href="articles/scaling.html">scaling</a>
    </li>
    <li>
      <a href="articles/species.html">species</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/diazrenata/birdsize/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>R1</h1>
    </div>


<div id="r1" class="section level1">

<p>Review Comments (annotations mine :))</p>
<blockquote>
<p>This is a useful, well-documented package with a clear and well defined scope. The documentation and vignettes have plenty of examples that I think most users should easily be able to follow. In addition to suggestions I’ve made in an earlier comment, I have a few suggestions that I think would improve the package documentation and align the source code better with best practices.</p>
</blockquote>
<blockquote>
<p>Working through the five vignettes, I did wonder if the vignette ordering and organization should be re-worked. For me, I found the population vignette to be the most useful for understanding what the package is actually doing under the hood. After working through this vignette, the community vignette made more sense to me. The species vignette covers an intermediate-level topic, so probably belongs next, followed by scaling since it’s a more advanced topic that many users won’t require knowledge of. Both the README and the “Getting Started” vignette contain essentially no code. This feels like missed opportunity to shown some of the most basic functionality, e.g. simulate a population of a single species and plot a histogram and/or simulate a community. Finally, there is fair amount of duplication in the vignettes, which makes me wonder if some of them could be combined together into one? All this may just be personal preference though, and other users may find the current organization better, but something to think about.</p>
</blockquote>
<p>Initial thought: maybe put the high-level workflow demonstration in the README and Getting Started and then re-focus the other vignettes to center more intermediate and advanced <em>topics</em> rather than the “level of organization” approach. So:</p>
<ul><li>high-level demo in README and/or Getting Started (think about redundancy here)</li>
<li>under-the-hood in greater detail (mostly, the content from the populations vignette)</li>
<li>scaling</li>
<li>species</li>
<li>integration with BBS (see below, also)</li>
</ul><blockquote>
<p>This package relies heavily on BBS data in all examples and package functionality. Given its prominence, I think there could more description of what the BBS is and the structure of the dataset. I initially assumed the bbs-data vignette would cover this, but it mostly duplicates what’s already found in the community vignette without providing additional explanation of the BBS. I think at the very least a brief description of the route/stop structure, sampling design, and spatial/temporal coverage of the BBS is warranted. Also, I see the fields of demo_route_raw are described in the help for that dataset, but I think you should point users to that help file or directly include a description of the fields in the bbs-data vignette. I don’t think you need to get into extensive detail since all of this is explained in other places, which you’ve referenced, but you should provide at least some explanation.</p>
</blockquote>
<p>Super helpful to get a gauge of how <em>much</em> context would seem helpful here (as I’m deep in the too-close-to-this-to-tell vortex). To-dos:</p>
<ul><li>add some more context on BBS methods and structure. Possibly as a section of the intro documentation (Getting Started), or the BBS vignette.</li>
<li>adding more explanation of the fields that are inherited in demo_route_raw. Here I am reflexively hesitant to duplicate the contents of the BBS metadata, but it seems like an appropriate context and one where doing so will make a big difference to usability.
<ul><li>and make sure there is a direct link to the ScienceBase permalink. (I intended there to be but want to confirm).</li>
</ul></li>
</ul><blockquote>
<p>Defining species in function arguments could be clarified. In the arguments to pop_generate() and species_define(), species can be identified either by AOU code or scientific name. Given that both genus and species are required, it feels more intuitive to me to use a single argument (e.g. scientific_name). The documentation also doesn’t make it clear that species is the species’ epithet and not the scientific or common name. As it stands, it feels like you should be able to call pop_generate(100, species = “Selasphorus calliope”) or even pop_generate(100, species = “Calliope Hummingbird”).</p>
</blockquote>
<p>+1 on combining genus and species as <code>scientific_name</code>.</p>
<p>I am of two minds on the common name lookup. It does seem intuitive and nice, but I wonder how accurate the matching would be? It would be easy to implement <em>perfect</em> matching. Or, to clarify in the docs that it has to be the scientific name.</p>
<blockquote>
<p>I wonder if the _summarize() functions are necessary since they’re essentially just calling group_by() %&gt;% summarize(). Personally I’d prefer to do this directly myself with dplyr so I know exactly what’s going on and the vignettes could demonstrate exactly how users should do it. However, I can imagine that some users aren’t as comfortable with dplyr so these convenience functions could be useful.</p>
</blockquote>
<p>Always a tough call. I like the idea of scooting it to the vignette for transparency. This would also help reduce, or at least compartmentalize, tidyverse deps.</p>
<blockquote>
<p>The internal function ind_draw() seems dangerous to me since it has a while loop to get rid of negative sizes with potential to run for a very long time. This is especially true because there appears to be no checks to ensure the mean size is positive. For example the following will run indefinitely:</p>
</blockquote>
<blockquote>
<p>pop_generate(1000, mean_size = -1000, sd_size = 0.001)</p>
</blockquote>
<blockquote>
<p>At the very least, please add a check to ensure mean_size and sd_size are positive and some method to ensure the while loop won’t run forever, e.g. after a certain number of iterations maybe it should stop and raise an error. Even better would be re-writing this function to use a less brute force method to ensure the sizes generated aren’t negative. It’s not immediately clear what that would look like, since simple solutions like take the absolute value, won’t preserve the desired normal distribution.</p>
</blockquote>
<p>This completely didn’t occur to me and is completely on point 😆.</p>
<p>To-do:</p>
<ul><li>test a truncated normal vs. rejection sampling with rules</li>
<li>add protections so the functions won’t take negative means</li>
<li>update docs</li>
</ul><blockquote>
<p>Some additional, specific comments about the code:</p>
</blockquote>
<blockquote>
<pre><code>I believe the standard for documenting package datasets is to document them all in R/data.R rather than individual R files. Not a huge issue, but I think this would help anyone interested find the source for the documentation more easily. See https://r-pkgs.org/data.html#sec-documenting-data.</code></pre>
</blockquote>
<p>Ah, ok!</p>
<blockquote>
<pre><code>Related to the previous point, you might consider renaming or re-grouping some of the other source files. For example, the only exported function in R/simulate_populations.R is pop_generate(), so why not call that file R/pop_generate.R so it's more obvious what's in the file?</code></pre>
</blockquote>
<p>To-do: revisit grouping of functions in .R files, thinking about readability.</p>
<blockquote>
<p>dplyr has deprecated or superseded a lot of the “scoped” verbs, e.g. group_by_at(). Please replace these as appropriate to future proof your package. See <a href="https://dplyr.tidyverse.org/reference/scoped.html" class="external-link uri">https://dplyr.tidyverse.org/reference/scoped.html</a></p>
</blockquote>
<p>Yikes. To-do: check this, unless it gets addressed as part of a de-tidyversing (see R2).</p>
<blockquote>
<p>I see some inconsistency in code styling. For example, in some places you use if() and in other places if (). I recommend picking one method of formatting your code and sticking with it. See <a href="https://style.tidyverse.org/" class="external-link uri">https://style.tidyverse.org/</a>.</p>
</blockquote>
<p>To-do: catch the styling</p>
<blockquote>
<p>In a few places I see you’re using as.numeric(NA) or is.character(NA) (e.g. <a href="https://github.com/diazrenata/birdsize/blob/main/R/species_define.R#L56" class="external-link uri">https://github.com/diazrenata/birdsize/blob/main/R/species_define.R#L56</a>). Note that there are NAs specifically for different data types, i.e. NA_real_ and NA_character_. It seems cleaner to use these rather than casting NA to different data types.</p>
</blockquote>
<p>I’ve never done this, but seems good to start! To-do: NA_character/NA_real.</p>
<blockquote>
<p>There are a handful of unnecessarily nested if statements (e.g. <a href="https://github.com/diazrenata/birdsize/blob/main/R/species_define.R#L54" class="external-link uri">https://github.com/diazrenata/birdsize/blob/main/R/species_define.R#L54</a>). Anywhere you have if (A) {if (B) {…}} I think it’s cleaner to use if (A &amp;&amp; B) {…}, but that may just be personal preference.</p>
</blockquote>
<p>To-do: check these. I think I personally find it easier to use the nested logic than the combination for some vague personal cognitive-flow thing, but it’s definitely more verbose.</p>
</div>
<div class="section level1">
<h1 id="r2">R2<a class="anchor" aria-label="anchor" href="#r2"></a></h1>
<blockquote>
<p>I think the purpose of the package is well-defined. It does a few well-defined and related tasks, and does them well. It also has demonstrated use cases, which is nice. The vignettes were well-organized and do a good job of providing examples of all the functions. I’ve divided my comments into three categories: code style, documentation, and “science stuff.”</p>
</blockquote>
<blockquote>
<p>Code style review</p>
</blockquote>
<blockquote>
<p>The DESCRIPTION file states that the package depends on R &gt;=2.10 but the tidyverse dependencies require R &gt;= 3.3.</p>
</blockquote>
<p>🤔 See below, I think the solution to this <em>may</em> be to untidy.</p>
<blockquote>
<p>I agree with Matt that the documentation of the package datasets should be in one data.R file which is a little easier to navigate (though this is not too relevant to users as they won’t ever see that, but it would be helpful for contributors)</p>
</blockquote>
<p>+1 on consolidating data documentation to data.R</p>
<blockquote>
<p>This is a tough one, but I generally try to shy away from having tidyverse dependencies in packages. For example the lines with dplyr::mutate() could be rewritten from</p>
</blockquote>
<blockquote>
<p>community &lt;- community %&gt;% dplyr::mutate( richnessSpecies = .data$aou, species_designator = “aou” )</p>
<p>to</p>
<p>community[[‘richnessSpecies’]] &lt;- community[[‘aou’]] community[[‘species_designator’]] &lt;- “aou”</p>
</blockquote>
<blockquote>
<p>I understand this would be a lot of work to implement because tidyverse is used in most of your functions. If you do not want to fully remove the tidyverse dependencies, the most urgent one to address would be to replace dplyr::group_by_at() with dplyr::group_by(dplyr::across()). group_by_at() has been deprecated and will likely be removed from future versions of dplyr. (I’m in agreement with Matt’s advice on that point).</p>
</blockquote>
<blockquote>
<pre><code>Also, having tidyverse dependencies greatly increases the number of downstream dependencies for the package which might not be desirable.</code></pre>
</blockquote>
<p>These comments (and conversations outside this) encourage me to move away from tidyverse dependencies. Most of the operations here are pretty simple and should translate to base reasonably easily, so <em>todo</em> start by reverting to base, and revisit this if there are components that really seem to need tidyverse.</p>
<blockquote>
<p>I also agree with Matt that it would be good to at least rewrite the code not to use the magrittr pipes %&gt;% for the reasons he cited.</p>
</blockquote>
<p>I think most of the pipes are in tidyverse paragraphs! <em>todo</em> make sure, though.</p>
<blockquote>
<pre><code>In filter_bbs_survey(), package data are loaded with unidentified_species &lt;- unidentified_species. I am not sure that is the recommended way to internally use package data. I noticed Matt also brought this up so I would follow his advice there.</code></pre>
</blockquote>
<p><em>Todo</em> fix how this is called.</p>
<blockquote>
<p>In simulate_populations(), the error checking routines that cause failure if things like mean and standard deviation aren’t provided is one level down in the ind_draw() function. To me it would make more sense if the input is checked for errors right away instead of further down.</p>
</blockquote>
<p>Can do!</p>
<blockquote>
<p>Line 33 of species_data_functions.R: the argument data to lm() should be named.</p>
</blockquote>
<p>Can do!</p>
<blockquote>
<p>Documentation review</p>
</blockquote>
<blockquote>
<pre><code>I thought the vignettes were well-organized and do a good job of providing examples of all the functions. One suggestion is that the vignettes could have more informative titles. Just the word community does not make it clear exactly what can be learned from going through the vignette.</code></pre>
</blockquote>
<p>I think this would be well-addressed by refocusing on topics (see above)</p>
<blockquote>
<p>I also liked the Taylor Swift example but shouldn’t the species be Taylor and the genus Swift? :-D</p>
</blockquote>
<p>Here for it.</p>
<blockquote>
<p>A user copying and pasting code from the vignettes will not be able to run the code containing tidyverse functions including select() and pmap_df() because those packages are not explicitly loaded in the vignette.</p>
</blockquote>
<p><em>Todo</em> if any tidyverse stays in the vignettes, make sure they are loaded visibly in the vignettes.</p>
<blockquote>
<p>The term “AOU” should be defined somewhere - it is known to North Americans but not otherwise. I understand this package is most intended for use with BBS so users will be familiar but it can’t hurt to define so that other people can understand what it is (maybe not necessarily the user but someone looking over the code). A related minor point: in some of the functions where AOU is an argument, it is in lowercase aou but I think it would be more consistent to make it capitalized AOU.</p>
</blockquote>
<p><em>Todo</em> Make sure to explain AOU (maybe as part of wider explanation of BBS data), and capitalize the argument.</p>
<blockquote>
<p>The bar plot with total biomass by AOU in the community vignette, as Matt mentioned, would be more informative with species names instead of AOU codes. Also, because the fill color legend is redundant with the axis labels, it would be cleaner to just label the x axis with the species names and suppress the legend of fill colors.</p>
</blockquote>
<p><em>Todo</em> Make sure this plot gets updated.</p>
<blockquote>
<p>Comments on science stuff</p>
</blockquote>
<blockquote>
<p>I would feel better about it if you explicitly incorporated uncertainty in the scaling relationships. The parameters for the relationship between body mass mean and standard deviation are average expectations, so you would end up underestimating the variation in body mass if you only use that mean expectation to impute missing standard deviations. Is there any way of incorporating uncertainty in those scaling parameters?</p>
</blockquote>
<p>I need to think about this one. Generally when I work with this method, I take the estimated mass and sd as the limit of the precision of this approach. The uncertainty is also variable among species - for some we have estimates and some measurements; for some species many measurements and some just one; and from different locations and times and investigators. For these reasons, I handle these estimates as “best-guesses suitable for broad-scale questions, but with some significant limitations as things get precise”….more thought needed.</p>
<blockquote>
<p>It would be nice to allow filter_bbs_survey() to take arguments so that the user could customize removing specific species groups. For instance it would be interesting if the user could remove only waterbirds and keep nocturnal birds, if they were so inclined.</p>
</blockquote>
<p><em>Todo</em> Check this out. I might need to go back to Dunning to get masses for waterbirds and nocturnal birds :)</p>
<blockquote>
<p>The real heart of the body mass distribution simulation is in the file simulate_populations.R in ind_draw() at line 34:</p>
</blockquote>
<blockquote>
<p>population &lt;- rnorm(n = species_abundance, mean = species_mean, sd = species_sd)</p>
<p>while (any(population &lt; 0)) { population[which(population &lt; 0)] &lt;- rnorm(n = sum(population &lt; 0), mean = species_mean, sd = species_sd) }</p>
</blockquote>
<blockquote>
<p>This looks like you are doing rejection sampling to generate samples from a truncated normal distribution with lower truncation bound of 0. I think that is fine, but it should be made clear in the documentation that you are doing this. I might even recommend allowing the user to input a lower truncation bound instead of hard-coding it at 0 (the default could be 0 but you could allow the user to modify this). For example the user might want to ensure that all masses are greater than 2 grams (that is roughly the lowest value I got when I generated the body masses for a_hundred_hummingbirds). Not too many birds weigh less than the Calliope Hummingbird! :-) Actually, in general I don’t think it is clear in your documentation that samples are drawn from a normal distribution. Yes, it is implied by the fact that the parameters are mean and standard deviation but I think it would be good to be explicit about it. I also wanted to address Matt’s point that the while loop in the rejection sampling may run infinitely or nearly so if invalid input is provided such as negative body mass. It would be good for you to expand the error checking code to cause failure on body mass means that are not positive, avoiding the potential of an infinite (or almost infinite loop).</p>
</blockquote>
<blockquote>
<pre><code>To further address the point about the rejection sampling method, Matt mentioned in his review that it would be good to use a "less brute force" method to ensure the values are &gt;0. Actually, the method of rejection sampling that you are currently using is a well-accepted method. It is used by the R package truncnorm. For almost any realistic values of body mass mean and sd, you will get very few negative values on the initial sample, so the while loop would hardly ever even be necessary. However, if you are interested in a more direct method of sampling from a truncated normal without the while loop, I would check out [this Stackoverflow thread](https://stats.stackexchange.com/questions/56747/simulate-constrained-normal-on-lower-or-upper-bound-in-r) especially [this answer](https://stats.stackexchange.com/a/510821/54923). There are also the existing functions msm::tnorm() and truncnorm::truncnorm() but you may not want to add a dependency to your package.</code></pre>
</blockquote>
<p>!!!! see above.</p>
<p>Additional todos:</p>
<ul><li>make sure the normal assumption is made crystal clear in the documentation</li>
<li>look into a user-specified lower limit other than 0</li>
</ul></div>
<div class="section level1">
<h1 id="others">Others<a class="anchor" aria-label="anchor" href="#others"></a></h1>
<ul><li>make sure test file names // source files names</li>
<li>tests fail due to an issue with unzip on windows. 👀</li>
<li>reach out to Dunning re: contributor-ship</li>
<li>and see the Small Fixes PR (which looks extremely helpful and above-and-beyond for peer review! <span class="emoji" data-emoji="raised_hands">🙌</span>)</li>
</ul></div>


  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by Renata Diaz.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

